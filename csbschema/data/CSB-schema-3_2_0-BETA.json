{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://raw.githubusercontent.com/CCOMJHC/csbschema/main/csbschema/data/CSB-schema-3_2_0-BETA.json",
  "title": "Schema for Crowdsourced Bathymetry data and metadata, version 3.2.0-BETA",
  "type": "object",
  "required": [
    "type",
    "crs",
    "properties",
    "features"
  ],
  "properties": {
    "type": {
      "type": "string",
      "enum": [
        "FeatureCollection"
      ]
    },
    "crs": { "$ref":  "#/definitions/CRS" },
    "properties": { "$ref": "#/definitions/B12_Metadata" },
    "features": {
      "type": "array",
      "items": { "$ref": "#/definitions/GeoJSONFeature" }
    }
  },
  "definitions": {
    "CRS_Name" : {
      "type": "string",
      "description": "CRS name as an EPSG string.",
      "pattern": "^EPSG:(3276[0-7]$|327[0-5]\\d$|32[0-6]\\d\\d$|3[0-1]\\d\\d\\d$|[1-2][0-9]{4}$|102[4-9]|10[3-9][0-9]$|1[1-9][0-9][0-9]$|[2-9][0-9][0-9][0-9]$)"
    },
    "CRS": {
      "type": "object",
      "required": [
        "properties"
      ],
      "properties": {
        "properties": {
          "type": "object",
          "required": [
            "name"
          ],
          "properties": {
            "name": { "$ref": "#/definitions/CRS_Name"}
          }
        }
      }
    },
    "RFC3339_time": {
      "type": "string",
      "description": "RFC3339 UTC time stamp",
      "pattern": "^([0-9]+)-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])[Tt]([01][0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9]|60)([.][0-9]+)?[Zz]$"
    },
    "B12_Metadata": {
      "type": "object",
      "required": [
        "trustedNodePlatform"
      ],
      "properties": {
        "trustedNode": { "$ref": "#/definitions/TrustedNodePlatform"},
        "observationCollection": { "$ref": "#/definitions/ObservationCollection" }
      }
    },
    "TrustedNodePlatform": {
      "type": "object",
      "required": [
        "providerOrganizationName",
        "providerEmail",
        "uniqueVesselID"
      ],
      "properties": {
        "providerOrganizationName": {
          "type": "string",
          "description": "The Trusted Node’s name, in free-text format."
        },
        "providerEmail": {
          "type": "string",
          "pattern": "^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,6}$",
          "description": "A free-text field for the Trusted Node’s email address, so that data users can contact the Trusted Node with questions about the data."
        },
        "uniqueVesselID": {
          "type": "string",
          "pattern": "^[a-zA-Z][a-zA-Z0-9]*-[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
          "description": "Generated by the Trusted Node, this number identifies the Trusted Node and uniquely identifies the contributing vessel. The characters preceding the hyphen (-) identify the Trusted Node, followed by a hyphen (-), and then the vessel’s unique identifier. The UUID assigned by the Trusted Node is consistent for each contributing vessel, throughout the life of service of the vessel. However, if the vessel chooses to remain anonymous to data users, the Trusted Node does not need to publish the vessel name in association with the UUID."
        },
        "type": {
          "type": "string",
          "description": "The type of vessel collecting the data, such as a cargo ship, fishing vessel, private vessel,\nresearch vessel, etc."
        },
        "name": {
          "type": "string",
          "description": "The name of the vessel, in open string format."
        },
        "IDType": {
          "type": "string",
          "description": "ID numbers used to uniquely identify vessels. Currently, only two types are available: Maritime Mobile Service Identity (MMSI) or International Maritime Organization (IMO) number. The MMSI number is used to uniquely identify a vessel through services such as AIS. The IMO number is linked to a vessel for its lifetime, regardless of change in flag or ownership. Contributors may select only one ID Type.",
          "enum": [
            "MMSI",
            "IMO"
          ]
        },
        "IDNumber": {
          "type": "string",
          "description": "The value for the ID Type. MMSI numbers are often nine digits, while IMO numbers are the letters “IMO,” followed by a seven-digit number.",
          "oneOf": [
            { "$ref": "#/definitions/IDNumber_MMSI" },
            { "$ref": "#/definitions/IDNumber_IMO"}
          ]
        }
      }
    },
    "ObservationCollection": {
      "type": "object",
      "properties": {
        "trustedNode": { "$ref": "#/definitions/ObservationCollectionTrustedNode" },
        "platform": { "$ref": "#/definitions/ObservationCollectionPlatform" },
        "processing": { "$ref": "#/definitions/ObservationCollectionProcessing" }
      }
    },
    "ObservationCollectionTrustedNode": {
      "type": "object",
      "properties": {
        "convention": {
          "type": "string",
          "enum": [
            "GeoJSON CSB 3.2"
          ],
          "description": "This field describes the format and version for the data and metadata, such as GeoJSON, CSV, or XYZT. Reference the version of the CSB data convention (e.g., CSB 2.0, CSB 3.0) where possible."
        },
        "dataLicense": {
          "type": "string",
          "description": "The Creative Commons public domain\n dedication under which the Trusted Node is\n providing CSB data to the IHO DCDB.\n "
        },
        "providerLogger": {
          "type": "string",
          "description": "The software program or hardware logger used to log the data."
        },
        "providerLoggerVersion": {
          "type": "string",
          "description": "The software or hardware logger version."
        },
        "navigationCRS": {
          "$ref": "#/definitions/CRS_Name",
          "description": "The EPSG code referring to the Coordinate Reference System (CRS) of the navigation data"
        },
        "verticalReferenceOfDepth": {
          "type": "string",
          "enum": [
            "Transducer",
            "Unknown"
          ],
          "description": "The vertical reference of the depth. The vertical reference will most likely be the transducer (ex: NMEA DBT string) or the waterline (ex: NMEA DPT string)."
        },
        "vesselPositionReferencePoint": {
          "type": "string",
          "enum": [
            "GNSS",
            "Transducer",
            "ReferencePlace"
          ],
          "description": "Position Reference Point (PRP) is the reference point where the navigation data is output. Most likely the reference point will be the location of the GNSS antenna."
        }
      }
    },
    "ObservationCollectionPlatform": {
      "type": "object",
      "properties": {
        "length": {
          "type": "integer",
          "description": "The length overall (LOA) of the vessel, expressed as a positive value, in metres, to the nearest metre.",
          "minimum": 1
        },
        "sensors": {
          "type": "array",
          "description": "Composite element containing all information about a given sensor in use on the collection platform. Minimum specification of fields as shown; some sensors may have additional fields (e.g., frequency for an echo sounder). Position is given from the PRP (Position Reference Point) in metres. The offsets are positive NED (North (Bow), East (Starboard), Down)",
          "minItems": 1,
          "items": {
            "oneOf": [
              { "$ref": "#/definitions/SensorDescriptionSounder" },
              { "$ref": "#/definitions/SensorDescriptionIMU" },
              { "$ref": "#/definitions/SensorDescriptionGNSS" }
            ]
          }
        },
        "soundSpeedDocumented": {
          "type": "boolean",
          "description": "Some systems may have the ability to provide sound speed data and correct the sounding. If details regarding such corrections are known (“True”), it is strongly recommended that the ‘Sound Speed Correction’ field in Table 4 be populated. If “False”, no information about how sound speed was applied has been recorded."
        },
        "positionOffsetsDocumented": {
          "type": "boolean",
          "description": "Describes whether the final vessel position (longitude and latitude) has been corrected for the lateral and longitudinal offsets between the GNSS receiver and the transducer (“True”), or if they were not (“False”). If “True”, the position element of the sensor description field in Table 3 should be populated."
        },
        "dataProcessed": {
          "type": "boolean",
          "description": "Raw data, without tidal corrections or additional processing, are preferable as a contribution to the IHO DCDB. This field allows the data contributor to state whether the data has been processed or corrected (‘True’) or not (‘False’). If ‘True’, it is strongly recommended that detailed information be captured in optional metadata fields as outlined in section 3.3.4. If ‘False’, information in section 3.3.4 is not needed."
        },
        "contributorComments": {
          "type": "string",
          "description": "If the contributor believes there were any problems or events that may have degraded the quality of the position or depth measurements, they can enter that information in this free-text field."
        }
      }
    },
    "IDNumber_MMSI": {
      "type": "string",
      "pattern": "^\\d{9}$"
    },
    "IDNumber_IMO": {
      "type": "string",
      "pattern": "^IMO\\d{7}$"
    },
    "SensorDescriptionSounder": {
      "type": "object",
      "required": [
        "type",
        "make",
        "model",
        "position"
      ],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "Sounder"
          ]
        },
        "make": { "$ref": "#/definitions/SensorMake" },
        "model": { "$ref": "#/definitions/SensorModel" },
        "position": { "$ref": "#/definitions/SensorPosition" },
        "draft": {
          "type": "number",
          "description": "Draft of vessel"
        },
        "draftUncert": {
          "type": "number",
          "description": "Uncertainty in vessel draft"
        },
        "frequency": {
          "type": "number",
          "description": "Frequency of echo sounder"
        },
        "pulseLength": {
          "type": "number",
          "description": "Pulse length of echo sounder"
        }
      }
    },
    "SensorDescriptionIMU": {
      "type": "object",
      "required": [
        "type",
        "make",
        "model",
        "position"
      ],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "IMU"
          ]
        },
        "make": { "$ref": "#/definitions/SensorMake" },
        "model": { "$ref": "#/definitions/SensorModel" },
        "position": { "$ref": "#/definitions/SensorPosition" }
      }
    },
    "SensorDescriptionGNSS": {
      "type": "object",
      "required": [
        "type",
        "make",
        "model"
      ],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "GNSS"
          ]
        },
        "make": { "$ref": "#/definitions/SensorMake" },
        "model": { "$ref": "#/definitions/SensorModel" },
        "position": { "$ref": "#/definitions/SensorPosition" },
        "antennaModel": {
          "type": "string",
          "description": "Model of GNSS antenna"
        }
      }
    },
    "SensorMake": {
      "type": "string",
      "description": "Sensor manufacturer"
    },
    "SensorModel": {
      "type": "string",
      "description": "Sensor model"
    },
    "SensorPosition": {
      "type": "array",
      "description": "Position is given from the PRP (Position Reference Point) in metres. The offsets are positive NED (North (Bow), East (Starboard), Down)",
      "minItems": 3,
      "maxItems": 3,
      "items": {
        "type": "number"
      }
    },
    "ObservationCollectionProcessing": {
      "type": "array",
      "description":  "List of processing steps recorded for the data",
      "minItems": 1,
      "items": {
        "oneOf": [
          { "$ref": "#/definitions/ProcessingTimeStampInterpolation" },
          { "$ref": "#/definitions/ProcessingCoordinateReferenceChange" },
          { "$ref": "#/definitions/ProcessingVerticalReduction" },
          { "$ref": "#/definitions/ProcessingGNSS" },
          { "$ref": "#/definitions/ProcessingSoundSpeedCorrection" },
          { "$ref": "#/definitions/ProcessingAlgorithm" }
        ]
      }
    },
    "ProcessingTimeStampInterpolation": {
      "type": "object",
      "required": [ "type", "timestamp", "method" ],
      "description": "Method by which times are assigned to data being recorded.",
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "soundSpeed"
          ]
        },
        "timestamp": { "$ref": "#/definitions/RFC3339_time" },
        "method": {
          "type": "string",
          "description": "Name of timestamp interpolation method."
        },
        "algorithm": {
          "type": "string",
          "description": "Algorithm used to interpolate timestamps."
        },
        "version": {
          "type": "string",
          "description": "Version of timestamp interpolation method used."
        }
      }
    },
    "ProcessingCoordinateReferenceChange": {
      "type": "object",
      "required": [ "type", "timestamp", "original", "destination" ],
      "description": "Processing that changed the reference system of the data. Must include the original and destination coordinate reference system, and the method used to change.",
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "CRSChange"
          ]
        },
        "timestamp":  { "$ref": "#/definitions/RFC3339_time" },
        "original": {
          "type": "string",
          "description": "Original coordinate reference system of the data (e.g., EPSG:4326)."
        },
        "destination": {
          "type": "string",
          "description": "Coordinate reference system to which data were transformed (e.g., EPSG:8252)."
        },
        "method": {
          "type": "string",
          "description": "Method used to change coordinates (e.g., GeoTrans)."
        }
      }
    },
    "ProcessingVerticalReduction": {
      "type": "object",
      "required": [ "type", "timestamp", "reference", "datum", "method" ],
      "description": "Steps taken to reduce raw data to a vertical reference system (Chart Datum, MSL, ellipsoid, water level, etc.). Must include the vertical reference system, and method used.",
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "VerticalReduction"
          ]
        },
        "timestamp":  { "$ref": "#/definitions/RFC3339_time" },
        "reference": {
          "type": "string",
          "description": "Vertical reference system (e.g., Chart Datum, MSL, ellipsoid, water level, etc.)"
        },
        "datum": {
          "type": "string",
          "description": "Datum of vertical reference system."
        },
        "method": {
          "type": "string",
          "description": "Method used to reduce raw data to vertical reference system.",
          "enum": [
            "EllipsoidReduction",
            "Observed Waterlevel",
            "Predicted Waterlevel"
          ]
        },
        "model": {
          "type": "string",
          "description": "Model used for reduction of raw data to vertical reference system"
        }
      }
    },
    "ProcessingGNSS": {
      "type": "object",
      "required": [ "type", "timestamp", "algorithm" ],
      "description": "Steps taken to post-process or improve horizontal and vertical positioning.",
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "GNSS"
          ]
        },
        "timestamp":  { "$ref": "#/definitions/RFC3339_time" },
        "algorithm": {
          "type": "string",
          "description": "Algorithm used for GNSS post-processing",
          "enum": [
            "RTKLib",
            "CSRS-PPP"
          ]
        },
        "version": {
          "type": "string",
          "description": "Version of GNSS post-processing algoritm method used."
        }
      }
    },
    "ProcessingSoundSpeedCorrection": {
      "type": "object",
      "required": [ "type", "timestamp", "source", "method" ],
      "description": "Correction to soundings for sound speed in the water.",
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "SoundSpeed"
          ]
        },
        "timestamp":  { "$ref": "#/definitions/RFC3339_time" },
        "source": {
          "type": "string",
          "description": "Source of correction to soundings."
        },
        "method": {
          "type": "string",
          "description": "Method of sounding correction."
        },
        "version": {
          "type": "string",
          "description": "Version of sounding correction method used."
        }
      }
    },
    "ProcessingAlgorithm": {
      "type": "object",
      "required": [ "type", "timestamp", "name" ],
      "description": "General algorithm used to triage data",
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "Algorithm"
          ]
        },
        "timestamp":  { "$ref": "#/definitions/RFC3339_time" },
        "name": {
          "type": "string",
          "description": "Examples: deduplicate, uncertainty estimation, manual editing"
        },
        "source": {
          "type": "string",
          "description": "Source (e.g., project, library) of the algorithm applied"
        },
        "parameters": {
          "type": ["null", "object"],
          "description": "Parameters used in data processing."
        },
        "version": {
          "type": "string",
          "description": "Version of algorithm used to triage data."
        },
        "comment": {
          "type": "string",
          "description":  "Explanatory text related to algorithm or its outputs"
        }
      }
    },
    "GeoJSONFeature": {
      "title": "GeoJSON Feature",
      "type": "object",
      "required": [
        "type",
        "properties",
        "geometry"
      ],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "Feature"
          ]
        },
        "id": {
          "oneOf": [
            {
              "type": "number"
            },
            {
              "type": "string"
            }
          ]
        },
        "properties": { "$ref": "#/definitions/CSBDatum" },
        "geometry": {
          "oneOf": [
            {
              "type": "null"
            },
            {
              "title": "GeoJSON Point",
              "type": "object",
              "required": [
                "type",
                "coordinates"
              ],
              "properties": {
                "type": {
                  "type": "string",
                  "enum": [
                    "Point"
                  ]
                },
                "coordinates": {
                  "type": "array",
                  "minItems": 2,
                  "items": {
                    "type": "number"
                  }
                },
                "bbox": {
                  "type": "array",
                  "minItems": 4,
                  "items": {
                    "type": "number"
                  }
                }
              }
            }
          ]
        }
      }
    },
    "CSBDatum": {
      "type": "object",
      "required": [
        "depth",
        "time"
      ],
      "properties": {
        "depth": {
          "type": "number",
          "description": "The distance from the vertical reference point to the seafloor. Should be collected as a positive value, in metres, with decimetre precision."
        },
        "time": {
          "description": "The date and UTC time stamp for the depth measurement as well as can be determined, ideally to millisecond precision in RFC3339 format.",
          "$ref": "#/definitions/RFC3339_time"
        }
      }
    }
  }
}
